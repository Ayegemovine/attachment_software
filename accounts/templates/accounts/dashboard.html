{% extends "accounts/base.html" %}
{% block content %}
<style>
    /* 1. LAYOUT: Full width with thin 15px side margins */
    .dashboard-full-width {
        width: 100%;
        padding-left: 15px;
        padding-right: 15px;
        margin: 0 auto;
    }

    /* 2. STAGES: Compact one-line row for Desktop */
    .stats-row {
        display: flex;
        flex-wrap: nowrap;
        gap: 10px;
        margin-bottom: 20px;
        overflow-x: auto;
    }
    .stats-row::-webkit-scrollbar { height: 4px; }
    .stats-row .col-item {
        flex: 1;
        min-width: 150px;
    }
    .glass-card { transition: all 0.3s ease; border: none !important; cursor: pointer; }
    .glass-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1) !important; }
    
    /* Highlight the active stage filter */
    .filter-active { border: 2.5px solid #55D47A !important; box-shadow: 0 5px 15px rgba(85, 212, 122, 0.2) !important; }

    /* 3. SEARCH & CONTROL BAR */
    .premium-header {
        background-color: #1a1a1a;
        background-image: linear-gradient(135deg, #1a1c1e 0%, #2c3e50 100%);
        border-bottom: 3px solid #55D47A;
        padding: 0.8rem 1.2rem !important;
    }
    .search-input-group {
        background: white;
        border-radius: 50px;
        padding: 3px;
        display: flex;
        align-items: center;
        width: 100%;
    }
    .rows-select { border: none !important; font-weight: bold; width: 105px !important; font-size: 0.85rem; }
    .search-input { border: none !important; border-left: 1px solid #eee !important; padding-left: 15px !important; font-size: 0.9rem; }
    
    .btn-action-group .btn {
        border-radius: 50px !important;
        font-weight: 700;
        padding: 6px 16px;
        margin-left: 4px;
        font-size: 0.8rem;
    }
    .btn-search { background-color: #55D47A !important; color: white !important; }

    /* 4. TABLE & COMPACT BADGES */
    .table-header-bg { background: #f8f9fa !important; border-bottom: 2px solid #55D47A !important; }
    .table-header-bg th { font-size: 0.75rem; padding: 12px 8px !important; text-transform: uppercase; }
    
    .status-badge {
        font-size: 0.65rem !important;
        padding: 4px 10px !important;
        font-weight: 800;
        letter-spacing: 0.3px;
    }

    /* 5. MODAL & PREVIEW */
    .modal-xl { max-width: 96%; }
    #previewContainer { min-height: 550px; background-color: #2c2c2c; display: flex; align-items: center; justify-content: center; overflow: hidden; }

    @media (max-width: 1200px) {
        .stats-row { flex-wrap: wrap; }
        .stats-row .col-item { flex: 0 0 calc(33.33% - 10px); }
    }
</style>

<form method="POST" enctype="multipart/form-data" action="{% url 'import_attachees' %}" id="importForm" style="display: none;">
    {% csrf_token %}
    <input type="file" name="import_file" id="importInput" onchange="document.getElementById('importForm').submit()">
</form>

<div class="dashboard-full-width mt-3 animate__animated animate__fadeIn">
    
    <div class="stats-row">
        <div class="col-item">
            <a href="?status=Pending&rows={{ rows }}" class="text-decoration-none">
                <div class="card shadow-sm rounded-4 bg-warning text-dark p-3 glass-card {% if status_filter == 'Pending' %}filter-active{% endif %}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><h6 class="small fw-bold opacity-75 mb-1" style="font-size: 0.6rem;">PENDING</h6><h4 class="fw-bold mb-0">{{ pending }}</h4></div>
                        <i class="fas fa-clock opacity-25"></i>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-item">
            <a href="?status=Approved&rows={{ rows }}" class="text-decoration-none">
                <div class="card shadow-sm rounded-4 bg-success text-white p-3 glass-card {% if status_filter == 'Approved' %}filter-active{% endif %}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><h6 class="small fw-bold opacity-75 mb-1" style="font-size: 0.6rem;">APPROVED</h6><h4 class="fw-bold mb-0">{{ approved }}</h4></div>
                        <i class="fas fa-check-circle opacity-25"></i>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-item">
            <a href="?status=In-Progress&rows={{ rows }}" class="text-decoration-none">
                <div class="card shadow-sm rounded-4 p-3 glass-card text-white {% if status_filter == 'In-Progress' %}filter-active{% endif %}" style="background-color: #6610f2;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><h6 class="small fw-bold opacity-75 mb-1" style="font-size: 0.6rem;">ADMITTED</h6><h4 class="fw-bold mb-0">{{ in_progress }}</h4></div>
                        <i class="fas fa-walking opacity-25"></i>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-item">
            <a href="?status=Completed&rows={{ rows }}" class="text-decoration-none">
                <div class="card shadow-sm rounded-4 bg-info text-white p-3 glass-card {% if status_filter == 'Completed' %}filter-active{% endif %}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><h6 class="small fw-bold opacity-75 mb-1" style="font-size: 0.6rem;">COMPLETED</h6><h4 class="fw-bold mb-0">{{ completed }}</h4></div>
                        <i class="fas fa-graduation-cap opacity-25"></i>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-item">
            <a href="?status=Rejected&rows={{ rows }}" class="text-decoration-none">
                <div class="card shadow-sm rounded-4 bg-danger text-white p-3 glass-card {% if status_filter == 'Rejected' %}filter-active{% endif %}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><h6 class="small fw-bold opacity-75 mb-1" style="font-size: 0.6rem;">REJECTED</h6><h4 class="fw-bold mb-0">{{ rejected }}</h4></div>
                        <i class="fas fa-times-circle opacity-25"></i>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-item">
            <a href="?status=&rows={{ rows }}" class="text-decoration-none">
                <div class="card shadow-sm rounded-4 bg-primary text-white p-3 glass-card {% if not status_filter %}filter-active{% endif %}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div><h6 class="small fw-bold opacity-75 mb-1" style="font-size: 0.6rem;">TOTAL</h6><h4 class="fw-bold mb-0">{{ total }}</h4></div>
                        <i class="fas fa-users opacity-25"></i>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="card shadow-lg border-0 rounded-4 overflow-hidden mb-4">
        <div class="card-header premium-header d-flex flex-column flex-xl-row justify-content-between align-items-center gap-3">
            <h5 class="mb-0 fw-bold text-white"><i class="fas fa-list-ul me-2" style="color: #55D47A;"></i>Review Board</h5>
            
            <form method="GET" action="{% url 'dashboard' %}" class="w-100" style="max-width: 1000px;">
                <input type="hidden" name="status" value="{{ status_filter }}">
                <div class="search-input-group shadow-sm">
                    <select name="rows" class="form-select rows-select px-2" onchange="this.form.submit()">
                        <option value="5" {% if rows == '5' %}selected{% endif %}>5 Rows</option>
                        <option value="10" {% if rows == '10' %}selected{% endif %}>10 Rows</option>
                        <option value="20" {% if rows == '20' %}selected{% endif %}>20 Rows</option>
                        <option value="50" {% if rows == '50' %}selected{% endif %}>50 Rows</option>
                        <option value="100" {% if rows == '100' %}selected{% endif %}>100 Rows</option>
                    </select>

                    <input type="text" name="q" class="form-control search-input" placeholder="Search ID, Name or Email..." value="{{ query }}">
                    
                    <div class="btn-action-group d-flex pe-1">
                        <button class="btn btn-search" type="submit">SEARCH</button>
                        <button type="submit" name="export" value="true" class="btn btn-dark">EXPORT</button>
                        <button type="button" class="btn btn-dark" onclick="document.getElementById('importInput').click()">IMPORT</button>
                        <a href="{% url 'dashboard' %}" class="btn btn-light border ms-1"><i class="fas fa-sync-alt text-muted"></i></a>
                    </div>
                </div>
            </form>
        </div>

        <div class="card-body p-0 bg-white">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-header-bg">
                        <tr>
                            <th class="ps-4">Tracking ID</th>
                            <th>Applicant Details</th>
                            <th>Timeline</th>
                            <th>Days Left</th>
                            <th>Status</th>
                            <th class="text-end pe-4">Decisions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for a in attachees %}
                        <tr>
                            <td class="ps-4"><span class="badge bg-light text-dark border px-2 py-2 fw-bold" style="font-size: 0.7rem;">{{ a.tracking_id }}</span></td>
                            <td><div class="fw-bold text-dark" style="font-size: 0.85rem;">{{ a.first_name }} {{ a.last_name }}</div><div class="small text-muted">{{ a.email }}</div></td>
                            <td class="small fw-bold text-secondary">{{ a.start_date|date:"d M" }} - {{ a.end_date|date:"d M Y" }}</td>
                            <td><span class="badge {% if a.days_remaining < 7 %}bg-danger{% else %}bg-dark{% endif %} px-2 py-1" style="font-size: 0.65rem;">{{ a.days_remaining }} Days</span></td>
                            <td>
                                <span class="badge rounded-pill status-badge text-uppercase" style="
                                    {% if a.status == 'Approved' %}background-color: #d1e7dd; color: #0f5132;
                                    {% elif a.status == 'In-Progress' %}background-color: #e0cffc; color: #6610f2;
                                    {% elif a.status == 'Rejected' %}background-color: #f8d7da; color: #842029;
                                    {% elif a.status == 'Completed' %}background-color: #cfe2ff; color: #084298;
                                    {% else %}background-color: #fff3cd; color: #856404;{% endif %}">
                                    {{ a.status }}
                                </span>
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn btn-sm btn-light border fw-bold px-3 py-1" style="font-size: 0.75rem;" onclick="openDetail({
                                    id: '{{ a.id }}',
                                    trackingId: '{{ a.tracking_id }}',
                                    firstName: '{{ a.first_name }}',
                                    lastName: '{{ a.last_name }}',
                                    idNum: '{{ a.national_id_number }}',
                                    email: '{{ a.email }}',
                                    phone: '{{ a.phone }}',
                                    institution: '{{ a.institution }}',
                                    startDate: '{{ a.start_date|date:'d M Y' }}',
                                    endDate: '{{ a.end_date|date:'d M Y' }}',
                                    status: '{{ a.status }}',
                                    notes: '{{ a.admin_notes|escapejs }}',
                                    idUrl: '{% if a.id_document %}{{ a.id_document.url }}{% endif %}',
                                    introUrl: '{% if a.intro_letter %}{{ a.intro_letter.url }}{% endif %}',
                                    cvUrl: '{% if a.curriculum_vitae %}{{ a.curriculum_vitae.url }}{% endif %}',
                                    contractUrl: '{% if a.signed_contract %}{{ a.signed_contract.url }}{% endif %}'
                                })">VIEW</button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="text-center py-5 text-muted">No applicants found in this category.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if attachees.has_other_pages %}
            <div class="p-3 border-top d-flex justify-content-center bg-light">
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        {% if attachees.has_previous %}
                            <li class="page-item"><a class="page-link shadow-none" href="?page={{ attachees.previous_page_number }}&status={{ status_filter }}&rows={{ rows }}&q={{ query }}">Previous</a></li>
                        {% endif %}
                        <li class="page-item active"><span class="page-link">{{ attachees.number }}</span></li>
                        {% if attachees.has_next %}
                            <li class="page-item"><a class="page-link shadow-none" href="?page={{ attachees.next_page_number }}&status={{ status_filter }}&rows={{ rows }}&q={{ query }}">Next</a></li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% endblock %}